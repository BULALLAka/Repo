import fs from 'fs';\nimport { MongoClient } from 'mongodb';\n\nconst MONGO_URI = process.env.MONGODB_URI ?? '';\nconst FILE_DB = 'db.json';\nlet mongoClient = null;\nlet usersCollection = null;\nlet useMongo = false;\n\nasync function initMongo() {\n  if (!MONGO_URI) return;\n  mongoClient = new MongoClient(MONGO_URI);\n  await mongoClient.connect();\n  const db = mongoClient.db(); // default db from URI\n  usersCollection = db.collection('users');\n  useMongo = true;\n  console.log('MongoDB ile bağlandı.');\n}\n\nlet initializing = (async () => {\n  try {\n    await initMongo();\n  } catch (e) {\n    console.warn('MongoDB bağlantısı başarısız veya yok, dosya tabanlı DB kullanılacak.');\n    useMongo = false;\n  }\n})();\n\nfunction safeUserTemplate(id) {\n  return {\n    id: String(id),\n    balance: 0,\n    bank: 0,\n    savings: [],\n    credits: [],\n    iban: null,\n    items: [],\n    stats: {\n      sent: 0,\n      received: 0,\n      gamesWon: 0,\n      gamesLost: 0\n    },\n    level: 1,\n    xp: 0,\n    lastDaily: 0,\n    lastWeekly: 0,\n    lastMonthly: 0,\n    createdAt: Date.now()\n  };\n}\n\nfunction readFileDB() {\n  if (!fs.existsSync(FILE_DB)) fs.writeFileSync(FILE_DB, JSON.stringify({ users: {} }, null, 2));\n  const raw = fs.readFileSync(FILE_DB, 'utf8');\n  return JSON.parse(raw);\n}\nfunction writeFileDB(data) {\n  fs.writeFileSync(FILE_DB, JSON.stringify(data, null, 2));\n}\n\nexport async function ensureUser(id) {\n  await initializing;\n  if (useMongo) {\n    let u = await usersCollection.findOne({ id: String(id) });\n    if (!u) {\n      u = safeUserTemplate(id);\n      await usersCollection.insertOne(u);\n    }\n    return u;\n  } else {\n    const db = readFileDB();\n    if (!db.users) db.users = {};\n    if (!db.users[id]) {\n      db.users[id] = safeUserTemplate(id);\n      writeFileDB(db);\n    }\n    return db.users[id];\n  }\n}\n\nexport async function getUser(id) {\n  await initializing;\n  if (useMongo) {\n    return await usersCollection.findOne({ id: String(id) });\n  } else {\n    const db = readFileDB();\n    return db.users?.[id] ?? null;\n  }\n}\n\nexport async function updateUser(user) {\n  await initializing;\n  if (!user || !user.id) throw new Error('Invalid user');\n  if (useMongo) {\n    await usersCollection.updateOne({ id: String(user.id) }, { $set: user }, { upsert: true });\n    return await usersCollection.findOne({ id: String(user.id) });\n  } else {\n    const db = readFileDB();\n    db.users = db.users || {};\n    db.users[user.id] = user;\n    writeFileDB(db);\n    return db.users[user.id];\n  }\n}\n\nexport async function addLog(client, text) {\n  const LOG_CHANNEL_ID = process.env.LOG_CHANNEL_ID;\n  if (!LOG_CHANNEL_ID) return;\n  try {\n    const ch = await client.channels.fetch(LOG_CHANNEL_ID);\n    if (ch && ch.send) ch.send(text);\n  } catch (e) {\n    console.warn('Log kanalı gönderilemedi:', e.message);\n  }\n}\n\nexport default {\n  ensureUser,\n  getUser,\n  updateUser,\n  addLog\n};