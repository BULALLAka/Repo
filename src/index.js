import 'dotenv/config';\nimport fs from 'fs';\nimport path from 'path';\nimport { fileURLToPath } from 'url';\nimport { Client, GatewayIntentBits, Collection, Partials, Events } from 'discord.js';\nimport { ensureUser, updateUser, addLog } from './db.js';\n\nconst __filename = fileURLToPath(import.meta.url);\nconst __dirname = path.dirname(__filename);\n\nconst BOT_TOKEN = process.env.BOT_TOKEN;\nconst PREFIX = process.env.PREFIX ?? 'x!';\nconst ADMIN_ID = process.env.ADMIN_ID ?? '1450895145271558245';\nconst LOG_CHANNEL_ID = process.env.LOG_CHANNEL_ID ?? null;\n\nif (!BOT_TOKEN) {\n  console.error('BOT_TOKEN .env içinde tanımlı değil. Lütfen .env dosyasını düzenleyin.');\n  process.exit(1);\n}\n\nconst client = new Client({\n  intents: [GatewayIntentBits.Guilds, GatewayIntentBits.GuildMessages, GatewayIntentBits.MessageContent],\n  partials: [Partials.Channel]\n});\n\nclient.commands = new Collection();\n\n// Komut yükleyici (src/commands klasörü)\nconst commandsPath = path.join(__dirname, 'commands');\nfunction loadCommands(dir) {\n  const entries = fs.readdirSync(dir, { withFileTypes: true });\n  for (const entry of entries) {\n    const full = path.join(dir, entry.name);\n    if (entry.isDirectory()) {\n      loadCommands(full);\n      continue;\n    }\n    if (!entry.name.endsWith('.js')) continue;\n    import(full).then(mod => {\n      const cmd = mod.default;\n      if (!cmd || !cmd.name) return;\n      client.commands.set(cmd.name, cmd);\n      if (cmd.aliases && Array.isArray(cmd.aliases)) {\n        for (const a of cmd.aliases) client.commands.set(a, cmd);\n      }\n      console.log(`Komut yüklendi: ${cmd.name}`);\n    }).catch(err => {\n      console.error('Komut yükleme hatası:', full, err);\n    });\n  }\n}\nif (fs.existsSync(commandsPath)) loadCommands(commandsPath);\nelse console.warn('Komut klasörü bulunamadı: src/commands');\n\nclient.once(Events.ClientReady, () => {\n  console.log(`Bot hazır: ${client.user.tag}`);\n});\n\nclient.on(Events.MessageCreate, async (message) => {\n  if (message.author.bot) return;\n  if (!message.content.startsWith(PREFIX)) {\n    // XP sistemi yine prefix dışı mesajlarda da çalışır (isteğe göre değiştirilebilir)\n    try {\n      const user = await ensureUser(message.author.id);\n      const gained = Math.floor(Math.random() * 5) + 1;\n      user.xp = (user.xp || 0) + gained;\n      const next = ((user.level || 1) * 100);\n      if (user.xp >= next) {\n        user.level = (user.level || 1) + 1;\n        user.xp = user.xp - next;\n        message.channel.send(`${message.author}, tebrikler! Seviye atladın: ${user.level}`);\n        if (LOG_CHANNEL_ID) {\n          const ch = await client.channels.fetch(LOG_CHANNEL_ID).catch(()=>null);\n          if (ch) ch.send(`Kullanıcı ${message.author.tag} seviye atladı: ${user.level}`);\n        }\n      }\n      await updateUser(user);\n    } catch (e) {\n      console.error('XP işlemi hata:', e);\n    }\n    return;\n  }\n\n  const args = message.content.slice(PREFIX.length).trim().split(/\s+/);\n  const commandName = args.shift().toLowerCase();\n\n  const command = client.commands.get(commandName);\n  if (!command) return;\n\n  try {\n    await command.execute({ client, message, args, PREFIX, ADMIN_ID, LOG_CHANNEL_ID });\n  } catch (err) {\n    console.error('Komut hata:', err);\n    message.reply('Bir hata oluştu. Konsolu kontrol et.');\n  }\n});\n\nclient.login(BOT_TOKEN);\n